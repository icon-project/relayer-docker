{{ $CORS_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN := .Env.CORS_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN | default "*" }}
{{ $DASHBOARD_PORT := .Env.DASHBOARD_PORT | default "3000"  }}


server_name _;

charset utf8;

client_max_body_size 0;

# Security headers
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";
add_header X-Robots-Tag none;
add_header X-Download-Options noopen;
add_header X-Permitted-Cross-Domain-Policies none;
add_header Referrer-Policy no-referrer;

root /usr/share/dashboard;
error_page 404 /static/404.html;

location ~ ^/.well-known/(.*)$ {
    alias /usr/src/dashboard/.well-known/$1;
}

location /_next/static/ {
    alias /usr/share/dashboard/.next/static/;
    add_header 'Access-Control-Allow-Origin' '{{ $CORS_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN }}';
    expires 1y;
    access_log off;
    add_header Cache-Control "public, max-age=31536000, immutable";
}

location ~* \.(?:ico|css|js|gif|jpe?g|png|svg|woff|woff2|eot|ttf)$ {
    alias /usr/share/dashboard/public/;
    add_header 'Access-Control-Allow-Origin' '{{ $CORS_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN }}';
    access_log off;
    if ($arg_v) {
        expires 1y;
        access_log off;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
}

location / {
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_pass http://localhost:{{ $DASHBOARD_PORT }};
}